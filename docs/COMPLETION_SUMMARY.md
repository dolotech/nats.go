# NATS å›è°ƒæ¨¡å¼æµå¼å¤„ç†å™¨ - å®Œæˆæ€»ç»“

## ğŸ¯ é¡¹ç›®ç›®æ ‡
åŸºäºç”¨æˆ·éœ€æ±‚ï¼Œå®ç°ä¸€ä¸ªä¼˜é›…çš„å›è°ƒæ¨¡å¼æµå¼å¤„ç†å™¨ï¼Œè§£å†³ç¬¬ä¸‰æ–¹APIå¼‚æ­¥å“åº”å¤„ç†çš„æ¶æ„é—®é¢˜ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ ¸å¿ƒå›è°ƒæ¨¡å¼å®ç°
- **ResponseSender æ¥å£**: æä¾› `Send()`, `SendError()`, `End()`, `IsClosed()` æ–¹æ³•
- **CallbackStreamHandler**: å¼‚æ­¥å›è°ƒå¼å¤„ç†å™¨å‡½æ•°ç±»å‹
- **streamResponseSender**: ResponseSender çš„å®Œæ•´å®ç°ï¼Œæ”¯æŒçŠ¶æ€æ£€æŸ¥å’Œç›‘æ§

### 2. æµå¼å¤„ç†å™¨ç±»å‹
- **StreamSubscribeHandler**: åŸºæœ¬å›è°ƒå¼æµå¼å¤„ç†å™¨
- **BatchStreamSubscribeHandler**: æ‰¹é‡å›è°ƒå¼æµå¼å¤„ç†å™¨  
- **LegacyStreamSubscribeHandler**: å…¼å®¹æ—§ç‰ˆå¤„ç†å™¨ï¼ˆå‘åå…¼å®¹ï¼‰

### 3. é”™è¯¯å¤„ç†å’Œç›‘æ§
- **é”™è¯¯ä¿¡å·**: `__STREAM_ERROR__:é”™è¯¯ä¿¡æ¯` æ ¼å¼
- **ç»“æŸä¿¡å·**: `__STREAM_END__` æ ‡å‡†ç»“æŸæ ‡è¯†
- **çŠ¶æ€æ£€æŸ¥**: `IsClosed()` é¿å…æ— æ•ˆå‘é€
- **å‘é€è®¡æ•°**: `GetSendCount()` æ”¯æŒç›‘æ§

### 4. å¹¶å‘å’Œèµ„æºç®¡ç†
- **å¼‚æ­¥å¤„ç†**: å¤„ç†å™¨ç«‹å³è¿”å›ï¼Œåç¨‹å¼‚æ­¥å‘é€æ•°æ®
- **ä¸Šä¸‹æ–‡æ§åˆ¶**: å®Œæ•´çš„ `context.Context` æ”¯æŒ
- **èµ„æºæ¸…ç†**: è‡ªåŠ¨èµ„æºæ¸…ç†å’Œè¿æ¥çŠ¶æ€ç®¡ç†
- **Panic é˜²æŠ¤**: å®Œæ•´çš„é”™è¯¯æ¢å¤æœºåˆ¶

### 5. æµ‹è¯•è¦†ç›–
- **åŸºæœ¬æµå¼è¯·æ±‚-å“åº”æµ‹è¯•**: âœ… é€šè¿‡
- **è¶…æ—¶å¤„ç†æµ‹è¯•**: âœ… é€šè¿‡
- **æ‰¹é‡æµå¼å¤„ç†æµ‹è¯•**: âœ… é€šè¿‡
- **ç¬¬ä¸‰æ–¹APIæ¨¡æ‹Ÿæµ‹è¯•**: âœ… é€šè¿‡
- **é‡è¯•æœºåˆ¶æµ‹è¯•**: âœ… é€šè¿‡
- **é‡è¯•åæˆåŠŸæµ‹è¯•**: âœ… é€šè¿‡

## ğŸ”§ æŠ€æœ¯ç‰¹æ€§

### ä¼˜é›…çš„æ¶æ„è®¾è®¡
- **éé˜»å¡**: å¤„ç†å™¨ç«‹å³è¿”å› `nil`ï¼Œå¯åŠ¨å¼‚æ­¥åç¨‹å¤„ç†
- **çŠ¶æ€æ„ŸçŸ¥**: éšæ—¶æ£€æŸ¥è¿æ¥çŠ¶æ€ï¼Œé¿å…æ— æ•ˆæ“ä½œ
- **é”™è¯¯ä¼ æ’­**: æ¸…æ™°çš„é”™è¯¯å¤„ç†å’Œä¼ æ’­æœºåˆ¶
- **èµ„æºæ•ˆç‡**: é¿å…é˜»å¡ï¼Œæé«˜ç³»ç»Ÿååé‡

### ç¬¬ä¸‰æ–¹APIå‹å¥½
```go
func thirdPartyAPIHandler(ctx context.Context, requestMsg *nats.Msg, sender ResponseSender) error {
    go func() {
        defer sender.End()
        
        // è°ƒç”¨ç¬¬ä¸‰æ–¹API
        resp, err := http.Get("https://api.example.com/stream")
        if err != nil {
            sender.SendError(err)
            return
        }
        defer resp.Body.Close()
        
        // æµå¼è¯»å–å¹¶è½¬å‘
        scanner := bufio.NewScanner(resp.Body)
        for scanner.Scan() {
            if sender.IsClosed() {
                return
            }
            sender.Send(scanner.Bytes())
        }
    }()
    
    return nil // ç«‹å³è¿”å›ï¼Œå¼‚æ­¥å¤„ç†
}
```

### å®Œæ•´çš„é”™è¯¯å¤„ç†
- **ä¸Šä¸‹æ–‡å–æ¶ˆ**: è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†ä¸Šä¸‹æ–‡å–æ¶ˆ
- **è¿æ¥æ–­å¼€**: æ™ºèƒ½æ£€æµ‹å®¢æˆ·ç«¯æ–­å¼€è¿æ¥
- **é‡è¯•æœºåˆ¶**: å†…ç½®é‡è¯•æ”¯æŒå’ŒæŒ‡æ•°é€€é¿
- **ç›‘æ§æ”¯æŒ**: å‘é€è®¡æ•°å’ŒçŠ¶æ€ç›‘æ§

## ğŸ“ æ–‡ä»¶ç»“æ„

```
message/
â”œâ”€â”€ nats_subscriber.go          # æ ¸å¿ƒè®¢é˜…è€…å’Œå›è°ƒæ¨¡å¼å®ç°
â”œâ”€â”€ nats_pool.go               # è¿æ¥æ± ï¼ˆå·²æœ‰ï¼‰
â”œâ”€â”€ nats_test.go               # å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ CALLBACK_USAGE_GUIDE.md    # è¯¦ç»†ä½¿ç”¨æŒ‡å—
â””â”€â”€ COMPLETION_SUMMARY.md      # æœ¬æ€»ç»“æ–‡æ¡£

cmd/
â””â”€â”€ callback_demo/
    â””â”€â”€ main.go                # æ¼”ç¤ºç¨‹åº
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### æœåŠ¡ç«¯
```go
// åˆ›å»ºè®¢é˜…è€…
subscriber, _ := NewSubscriber([]string{"nats://localhost:4222"})
defer subscriber.Close(context.Background())

// æ³¨å†Œå›è°ƒå¼å¤„ç†å™¨
handler := func(ctx context.Context, requestMsg *nats.Msg, sender ResponseSender) error {
    go func() {
        defer sender.End()
        
        // å¼‚æ­¥å¤„ç†é€»è¾‘
        for i := 0; i < 10; i++ {
            if sender.IsClosed() {
                return
            }
            
            data := fmt.Sprintf("å“åº”æ•°æ®_%d", i)
            sender.Send([]byte(data))
            time.Sleep(100 * time.Millisecond)
        }
    }()
    
    return nil
}

subscriber.StreamSubscribeHandler(ctx, "my.stream", handler)
```

### å®¢æˆ·ç«¯
```go
// åˆ›å»ºè¿æ¥æ± 
pool, _ := New(Config{Servers: []string{"nats://localhost:4222"}})
defer pool.Close()

// å“åº”å¤„ç†å™¨
responseProcessor := func(msg *nats.Msg) bool {
    data := string(msg.Data)
    
    if data == "__STREAM_END__" {
        return false // ç»“æŸ
    }
    
    if strings.HasPrefix(data, "__STREAM_ERROR__") {
        log.Printf("é”™è¯¯: %s", data)
        return false
    }
    
    log.Printf("æ”¶åˆ°æ•°æ®: %s", data)
    return true // ç»§ç»­æ¥æ”¶
}

// å‘èµ·æµå¼è¯·æ±‚
pool.StreamRequest(ctx, "my.stream", requestData, responseProcessor)
```

## ğŸ‰ å®ŒæˆçŠ¶æ€

âœ… **æ ¸å¿ƒåŠŸèƒ½**: å›è°ƒæ¨¡å¼æµå¼å¤„ç†å™¨å®Œå…¨å®ç°  
âœ… **é”™è¯¯å¤„ç†**: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶  
âœ… **æµ‹è¯•è¦†ç›–**: æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡  
âœ… **æ–‡æ¡£å®Œå–„**: è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œç¤ºä¾‹  
âœ… **å‘åå…¼å®¹**: ä¿æŒä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§  
âœ… **ç”Ÿäº§å°±ç»ª**: ç»è¿‡å……åˆ†æµ‹è¯•ï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ  

## ğŸ”® ä¼˜åŠ¿æ€»ç»“

1. **è§£å†³æ¶æ„é—®é¢˜**: å®Œç¾è§£å†³ç¬¬ä¸‰æ–¹APIå¼‚æ­¥å“åº”å¤„ç†çš„æ¶æ„éš¾é¢˜
2. **æé«˜æ€§èƒ½**: éé˜»å¡å¼‚æ­¥å¤„ç†ï¼Œæ˜¾è‘—æå‡ç³»ç»Ÿååé‡
3. **å¢å¼ºç¨³å®šæ€§**: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†æœºåˆ¶
4. **é™ä½å¤æ‚åº¦**: ç®€æ´ä¼˜é›…çš„APIè®¾è®¡ï¼Œé™ä½ä½¿ç”¨å¤æ‚åº¦
5. **æ˜“äºç›‘æ§**: å†…ç½®ç›‘æ§æŒ‡æ ‡ï¼Œä¾¿äºè¿ç»´ç®¡ç†

**é¡¹ç›®å·²å®Œæˆï¼Œä»£ç ç¨³å®šå¯é ï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼** ğŸš€ 